<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源史诗</title>
    <style>
        :root {
            color-scheme: dark;
            font-size: 24px;
            touch-action: none;
        }
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        /* 目录 */
        #nav {
            block-size: 2rem;
            display: flex;
            user-select: none;
            -webkit-user-select: none; /* I hate having to write this. */
        }
        #nav > * {
            flex-grow: 1;
            text-align: center;
            padding-block: calc(1rem - 0.5lh);
            background-color: #333; /* We'll polish the styling *later*. */
            cursor: pointer;
        }
        #nav > :hover {
            background-color: #444;
        }
        #nav > label {
            flex-grow: 0;
            inline-size: 2rem;
        }
        #navstyle {
            display: none;
        }
        body:has(#navstyle:checked) {
            flex-direction: row;
        }
        #nav:has(#navstyle:checked) {
            writing-mode: vertical-rl;
        }

        /* 主窗口 */
        #main {
            position: relative;
            inset: 0;
            flex-grow: 1;
            overflow: hidden;
        }
        iframe {
            border: none;
            display: block;
            width: 100%;
            position: absolute;
        }
    </style>
</head>
<body>
    <div id="nav">
        <input id="navstyle" name="navstyle" type="checkbox"/>
        <label for="navstyle">⇉</label>
        <div data-bookmark="preface">序言</div>
        <div data-bookmark="part1">流动的能源</div>
        <div data-bookmark="part2">计算的能源</div>
        <div data-bookmark="part3">自然的能源</div>
        <div data-bookmark="part4">终极的能源</div>
        <div data-bookmark="summary">总结</div>
    </div>
    <div id="main">
        <iframe src="preface.html" data-bookmark="preface" scrolling="no"></iframe>
        <iframe src="pre1.html" data-bookmark="part1" scrolling="no"></iframe>
        <iframe src="/part1/website_head.html" scrolling="no"></iframe>
        <iframe src="/part1/flowchart.html" scrolling="no"></iframe>
        <iframe src="/part1/website.html" scrolling="no"></iframe>
        <iframe src="/part1/visualization.html" scrolling="no"></iframe>
        <iframe src="pre2.html" data-bookmark="part2" scrolling="no"></iframe>
        <iframe src="/part2/index.html" scrolling="no"></iframe>
        <iframe src="pre3.html" data-bookmark="part3" scrolling="no"></iframe>
        <iframe src="/part3/doc.html" scrolling="no"></iframe>
        <iframe src="pre4.html" data-bookmark="part4" scrolling="no"></iframe>
        <iframe src="/part4/index.html" scrolling="no"></iframe>
        <iframe src="summary.html" data-bookmark="summary" scrolling = "no"></iframe>
    </div>

    <script>
        const /** @type {HTMLDivElement} */ main = document.getElementById("main");
        var pageHeight = 0;
        var scrollY = 0;

        // 一个记录 iframe 数据的类
        class DocIFrame {
            /** @type {HTMLIFrameElement} */ iframe;
            /** @type {number} */ docHeight;
            /** @type {number} */ pos;
            /** @type {string | null} */ bookmark;

            constructor(/** @type {HTMLIFrameElement} */ iframe) {
                this.iframe = iframe;
                this.docHeight = 0;
                this.pos = 0;
                this.bookmark = iframe.getAttribute("data-bookmark");
            }
            // 读取文件高度
            updateDocHeight() {
                try {
                    return this.docHeight = this.iframe.contentWindow.document.documentElement.offsetHeight;
                } catch (e) {}
                return this.docHeight = 0;
            }
            // 设置 iframe 高度
            setHeight(height = Math.min(main.clientHeight, this.docHeight)) {
                this.iframe.style.height = `${height}px`;
            }
            // 挪动 iframe 位置 & 滚动内容
            scrollTo(/** @type {number} */ top, /** @type {number} */ scrollY) {
                this.iframe.style.top = `${top}px`;
                this.iframe.contentWindow.scrollTo(0, scrollY);
            }
            // 页面加载完成时触发函数
            onready() {
                return new Promise((resolve, reject) => {
                    const readyState = this.iframe.contentWindow.document.readyState;
                    if (readyState === "interactive" || readyState === "complete")
                        resolve();
                    else
                        this.iframe.contentWindow.addEventListener("DOMContentLoaded", () => resolve());
                });
            }
            addListener(...args) {
                this.iframe.contentWindow.addEventListener(...args);
            }
        }

        const /** @type {Map<string, DocIFrame>} */ bookmarks = new Map();
        const /** @type {DocIFrame[]} */ docs = Array.from(document.getElementsByTagName("iframe")).map((iframe) => {
            const doc = new DocIFrame(iframe);
            const bookmark = iframe.getAttribute("data-bookmark");
            if (typeof bookmark === "string")
                bookmarks.set(bookmark, doc);
            return doc;
        });

        // 更新所有 doc 的高度和位置
        function setHeights() {
            pageHeight = 0;
            for (const doc of docs) {
                doc.pos = pageHeight;
                pageHeight += doc.updateDocHeight();
                doc.setHeight();
            }
            return pageHeight;
        }

        function render() {
            const mainHeight = main.clientHeight;
            setHeights();
            clampScrollY();
            for (const doc of docs) {
                const top = doc.pos - scrollY;
                if (top >= 0 || doc.docHeight <= mainHeight)
                    doc.scrollTo(top, 0);
                else if (top <= mainHeight - doc.docHeight)
                    doc.scrollTo(top + doc.docHeight - mainHeight, doc.docHeight);
                else
                    doc.scrollTo(0, -top);
            }
        }

        const /** @type {Map<number, number>} */ touchY = new Map();
        const a = 2;
        var sy = 0;
        var ty = 0;
        var dy = 0;
        var vy = 0;
        
        // 手动滚动
        function clampScrollY() {
            if (scrollY <= 0)
                scrollY = 0;
            if (scrollY >= pageHeight - main.clientHeight)
                scrollY = pageHeight - main.clientHeight;
        }
        function scroll(/** @type {number} */ dy) {
            scrollY += dy;
            clampScrollY();
            render();
        }
        function goto_bookmark(/** @type {string} */ bookmark) {
            const doc = bookmarks.get(bookmark);
            if (typeof doc === "undefined")
                return;
            scrollY = doc.pos;
            clampScrollY();
            render();
        }

        // 监听鼠标滚轮
        function handleMouseWhell(/** @type {WheelEvent} */ e) {
            scroll(e.deltaY);
        }

        // 监听触碰
        function setTouch(/** @type {Touch} */ touch) {
            const prev = touchY.get(touch.identifier);
            if (typeof prev === "number")
                sy -= prev;
            touchY.set(touch.identifier, touch.screenY);
            sy += touch.screenY;
        }
        function handleTouchStart(/** @type {TouchEvent} */ e) {
            vy = 0;
            for (let i = 0; i < e.changedTouches.length; i++) {
                setTouch(e.changedTouches[i]);
            }
            ty = sy / touchY.size;
        }
        function handleTouchMove(/** @type {TouchEvent} */ e) {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                setTouch(touch);
            }
            const ty1 = sy / touchY.size;
            scroll(dy = ty - ty1);
            ty = ty1;
        }
        function handleTouchEnd(/** @type {TouchEvent} */ e) {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                const prev = touchY.get(touch.identifier);
                if (typeof prev === "number") {
                    sy -= prev;
                    touchY.delete(touch.identifier);
                }
            }
            if (!touchY.size) {
                vy = dy;
                dy = 0;
            }
        }

        // 初始化 doc
        docs.forEach((doc) => doc.onready().then(() => {
            doc.addListener("wheel", handleMouseWhell);
            doc.addListener("touchstart", handleTouchStart);
            doc.addListener("touchmove", handleTouchMove);
            doc.addListener("touchend", handleTouchEnd);
            doc.addListener("touchcancel", handleTouchEnd);
            setHeights();
            render();
        }));

        // 初始化目录
        Array.from(document.getElementById("nav").children).forEach((d) => {
            const bookmark = d.getAttribute("data-bookmark");
            if (typeof bookmark === "string") {
                d.addEventListener("click", () => goto_bookmark(bookmark));
            }
        });

        function frame() {
            if (!touchY.size) {
                scroll(vy);
                vy *= 0.95;
                // if (vy > a)
                //     vy -= a;
                // else if (vy < -a)
                //     vy += a;
                // else
                //     vy = 0;
            }
            requestAnimationFrame(frame);
        }

        document.getElementById("navstyle").addEventListener("change", () => render());
        addEventListener("resize", () => render());
        addEventListener("wheel", handleMouseWhell);
        addEventListener("touchstart", handleTouchStart);
        addEventListener("touchmove", handleTouchMove);
        addEventListener("touchend", handleTouchMove);
        addEventListener("touchcancel", handleTouchMove);

        frame();
    </script>
</body>
</html>