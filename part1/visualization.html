<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国新能源汽车发展可视化 (2020 vs 2025)</title>
    
    <!-- CSS 内容 -->
    <style>
        /* 基本样式重置 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #fdfdfd;
            color: #333;
        }

        /* 交互式页面布局 */
        .interactive-container {
            display: flex;
            flex-direction: row;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 左侧：滚动文字区域 */
        .text-column {
            flex: 1;
            max-width: 600px;
            padding: 0 40px;
        }

        /* 右侧：固定的可视化图表区域 */
        .viz-column {
            flex: 1.5;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        /* ECharts 图表容器样式 */
        #main {
            height: 100%;
            width: 100%;
        }

        /* 每一个滚动触发的步骤 */
        .step {
            min-height: 95vh; /* 保证有足够的滚动空间来触发切换 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            opacity: 0.3;
            transition: opacity 0.4s ease-in-out;
            border-left: 4px solid #e0e0e0;
            padding: 0 20px;
        }
        
        /* 当前激活的步骤样式 */
        .step.active {
            opacity: 1;
            border-left-color: #007aff;
        }

        .step h2 {
            font-size: 2em;
            color: #1a1a1a;
            margin-bottom: 1em;
        }

        .step p {
            font-size: 1.1em;
            line-height: 1.8;
        }
        
        /* 关键修复：增加一个透明的垫片元素，确保最后一个step有足够空间滚过触发点 */
        .spacer {
            height: 50vh;
        }

    </style>
</head>
<body>

    <div class="interactive-container">
        <!-- 左侧滚动文字 -->
        <div class="text-column">
            <div class="step" data-year="2020">
                <h2>2020年：新生的市场格局</h2>
                <p>在2020年，中国的新能源汽车市场仍处于发展的初期阶段。从右侧的地图中可以看到，无论是电动汽车的保有量（圆圈大小）还是充电桩的密度（圆圈颜色），整体规模都相对较小。市场主要集中在少数几个经济发达地区，如北京、上海和广东，这些地区的居民人均可支配收入（地图颜色）也处于全国领先地位。大部分中西部省份的新能源基础设施尚在起步，显示出市场发展的不均衡性，同时也预示着巨大的增长潜力。</p>
            </div>
            <div class="step" data-year="2025">
                <h2>2025年：爆发式增长与全面渗透</h2>
                <p>步入2025年，图景发生了翻天覆地的变化。全国范围内，新能源汽车的保有量实现了爆炸性增长，几乎所有省份的代表圆圈都显著增大。特别是在长三角（江浙沪）、珠三角（广东）和山东等地区，形成了庞大的产业集群。更重要的是，充电桩密度大幅提升，圆圈颜色普遍向代表高密度的橙红色转变，显示出基础设施建设的快速跟进。这标志着新能源汽车正从一线城市向更广阔的区域渗透，一个全面电动化的交通新时代已然来临。</p>
            </div>
            <!-- 增加一个垫片来解决最后一个元素无法触发的问题 -->
            <div class="spacer"></div>
        </div>

        <!-- 右侧固定图表 -->
        <div class="viz-column">
            <div id="main"></div>
        </div>
    </div>

    <!-- ECharts 库 -->
    <script src="/lib/echarts.min.js"></script>
    
    <!-- JS 逻辑 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const myChart = echarts.init(document.getElementById('main'));

            const geoCoordMap = {
                '安徽': [117.28, 31.86], '北京': [116.46, 39.92], '重庆': [106.54, 29.59], '福建': [119.3, 26.08],
                '甘肃': [103.73, 36.03], '广东': [113.23, 23.16], '广西': [108.33, 22.84], '贵州': [106.71, 26.57],
                '海南': [110.35, 20.02], '河北': [114.48, 38.03], '河南': [113.65, 34.76], '黑龙江': [126.63, 45.75],
                '湖北': [114.31, 30.52], '湖南': [112.93, 28.21], '吉林': [125.35, 43.88], '江苏': [118.78, 32.04],
                '江西': [115.89, 28.68], '辽宁': [123.38, 41.8], '内蒙古': [111.65, 40.82], '宁夏': [106.27, 38.47],
                '青海': [101.74, 36.56], '山东': [117, 36.65], '山西': [112.53, 37.87], '陕西': [108.95, 34.27],
                '上海': [121.48, 31.22], '四川': [104.06, 30.67], '天津': [117.2, 39.13], '西藏': [91.11, 29.97],
                '新疆': [87.68, 43.77], '云南': [102.73, 25.04], '浙江': [120.19, 30.26], '台湾': [121.5, 25.03]
            };

            const rawData = {
                2020: [ { name: '安徽', income: 2.81, ev: 10.5, density: 13.77 }, { name: '北京', income: 6.94, ev: 40, density: 79.31 }, { name: '重庆', income: 3.08, ev: 4.8, density: 14.06 }, { name: '福建', income: 3.72, ev: 13.06, density: 17.38 }, { name: '甘肃', income: 2.03, ev: 1.66, density: 2.20 }, { name: '广东', income: 4.1, ev: 50, density: 26.48 }, { name: '广西', income: 2.46, ev: 13.48, density: 4.40 }, { name: '贵州', income: 2.18, ev: 6.62, density: 3.08 }, { name: '海南', income: 2.79, ev: 6.36, density: 25.00 }, { name: '河北', income: 2.71, ev: 11.78, density: 6.22 }, { name: '河南', income: 2.48, ev: 33.6, density: 6.22 }, { name: '黑龙江', income: 2.49, ev: 2.89, density: 1.00 }, { name: '湖北', income: 2.79, ev: 72.3, density: 11.72 }, { name: '湖南', income: 2.94, ev: 22, density: 9.38 }, { name: '吉林', income: 2.58, ev: 1.2, density: 2.17 }, { name: '江苏', income: 4.34, ev: 22.7, density: 19.41 }, { name: '江西', income: 2.8, ev: 10.5, density: 13.33 }, { name: '辽宁', income: 3.27, ev: 5.64, density: 3.10 }, { name: '内蒙古', income: 3.15, ev: 4.3, density: 1.25 }, { name: '宁夏', income: 2.57, ev: 1, density: 2.14 }, { name: '青海', income: 2.4, ev: 0.18, density: 1.67 }, { name: '山东', income: 3.29, ev: 40.5, density: 11.51 }, { name: '山西', income: 2.52, ev: 37.168, density: 7.35 }, { name: '陕西', income: 2.62, ev: 10.49, density: 10.50 }, { name: '上海', income: 7.22, ev: 42.4, density: 150.76 }, { name: '四川', income: 2.65, ev: 12.3, density: 10.12 }, { name: '天津', income: 4.39, ev: 15, density: 32.14 }, { name: '西藏', income: 2.17, ev: 0, density: 0.63 }, { name: '新疆', income: 2.38, ev: 5, density: 0.81 }, { name: '云南', income: 2.33, ev: 5.5, density: 2.77 }, { name: '浙江', income: 5.24, ev: 43, density: 9.25 }, { name: '台湾', income: 7.5, ev: 0.81, density: 1.13 } ],
                2025: [ { name: '安徽', income: 3.68, ev: 107.6, density: 120.98 }, { name: '北京', income: 8.54, ev: 100.9, density: 139.31 }, { name: '重庆', income: 3.97, ev: 70.65, density: 100.00 }, { name: '福建', income: 4.79, ev: 87.89, density: 40.48 }, { name: '甘肃', income: 2.66, ev: 20, density: 20.00 }, { name: '广东', income: 5.15, ev: 361.78, density: 57.42 }, { name: '广西', income: 3.11, ev: 92.37, density: 40.00 }, { name: '贵州', income: 2.86, ev: 49.94, density: 49.33 }, { name: '海南', income: 3.48, ev: 46.42, density: 183.80 }, { name: '河北', income: 3.47, ev: 70, density: 19.45 }, { name: '河南', income: 3.16, ev: 200, density: 19.49 }, { name: '黑龙江', income: 3.13, ev: 20, density: 5.07 }, { name: '湖北', income: 3.69, ev: 100, density: 39.83 }, { name: '湖南', income: 3.77, ev: 77.1, density: 64.85 }, { name: '吉林', income: 3.13, ev: 20.53, density: 52.17 }, { name: '江苏', income: 5.54, ev: 269.1, density: 136.12 }, { name: '江西', income: 3.6, ev: 59.6, density: 13.33 }, { name: '辽宁', income: 3.98, ev: 39, density: 25.95 }, { name: '内蒙古', income: 4.008, ev: 38.9, density: 12.04 }, { name: '宁夏', income: 3.34, ev: 14.98, density: 11.43 }, { name: '青海', income: 3.01, ev: 1.2, density: 11.67 }, { name: '山东', income: 4.21, ev: 272.3, density: 42.62 }, { name: '山西', income: 3.24, ev: 65.2, density: 22.79 }, { name: '陕西', income: 3.39, ev: 39.77, density: 74.95 }, { name: '上海', income: 8.84, ev: 151.2, density: 392.40 }, { name: '四川', income: 3.43, ev: 140.2, density: 97.58 }, { name: '天津', income: 5.36, ev: 70, density: 177.14 }, { name: '西藏', income: 3.14, ev: 1.3, density: 2.50 }, { name: '新疆', income: 3.09, ev: 28.96, density: 10.38 }, { name: '云南', income: 2.99, ev: 55.66, density: 2.55 }, { name: '浙江', income: 6.7, ev: 300, density: 238.81 }, { name: '台湾', income: 9.11, ev: 8.9, density: 5.17 } ]
            };

            const allData = [...rawData[2020], ...rawData[2025]];
            const minIncome = Math.min(...allData.map(item => item.income));
            const maxIncome = Math.max(...allData.map(item => item.income));
            const maxEv = Math.max(...allData.map(item => item.ev));
            const minDensity = Math.min(...allData.map(item => item.density));
            const maxDensity = Math.max(...allData.map(item => item.density));

            function processData(year) {
                const data = rawData[year];
                const mapData = data.map(item => ({ name: item.name, value: item.income }));
                const scatterData = data.map(item => {
                    const geo = geoCoordMap[item.name.replace(/省|市|自治区|壮族|回族|维吾尔/g, '')];
                    if (geo) {
                        return { name: item.name, value: [...geo, item.ev, item.density, item.income] };
                    }
                    return null;
                }).filter(Boolean);
                return { mapData, scatterData };
            }

            function getOption(year) {
                const { mapData, scatterData } = processData(year);
                return {
                    title: {
                        text: `${year}年全国人均可支配收入与新能源汽车数据`,
                        left: 'center',
                        textStyle: { color: '#333' },
                        subtextStyle: { color: '#666' }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: (params) => {
                            if (params.seriesType === 'scatter') {
                                return `${params.name}<br/>电动汽车保有量: ${params.value[2].toFixed(2)} 万辆<br/>充电桩密度: ${params.value[3].toFixed(2)} 个/每万人<br/>人均可支配收入: ${params.value[4].toFixed(2)} 万元`;
                            } else if (params.seriesType === 'map') {
                                return `${params.name}<br/>人均可支配收入: ${params.value ? params.value.toFixed(2) + ' 万元' : '无数据'}`;
                            }
                            return '';
                        }
                    },
                    visualMap: [
                        { seriesIndex: 0, min: minIncome, max: maxIncome, left: 20, bottom: 20, text: ['人均可支配收入(万)', ''], calculable: true, inRange: { color: ['#cceeff', '#0077be'] }, textStyle: { color: '#333' } },
                        { seriesIndex: 1, dimension: 2, min: 0, max: maxEv, right: 20, bottom: 200, orient: 'vertical', text: ['电动汽车保有量(万)', ''], calculable: true, inRange: { symbolSize: [8, 60] }, textStyle: { color: '#333' } },
                        { seriesIndex: 1, dimension: 3, min: minDensity, max: maxDensity, right: 20, bottom: 20, text: ['充电桩密度(个/万人)', ''], calculable: true, inRange: { color: ['#9dff9d', '#ff4500'] }, textStyle: { color: '#333' } }
                    ],
                    geo: { 
                        map: 'china', 
                        roam: false, 
                        label: { show: true, color: '#444', fontSize: 10 }, 
                        itemStyle: { areaColor: '#f3f3f3', borderColor: '#bbb' }, 
                        emphasis: { label: { color: '#000' }, itemStyle: { areaColor: '#d5d5d5' } } 
                    },
                    series: [
                        { name: '人均可支配收入', type: 'map', geoIndex: 0, data: mapData },
                        { name: '电动汽车与充电桩', type: 'scatter', coordinateSystem: 'geo', data: scatterData, itemStyle: { borderColor: 'rgba(0, 0, 0, 0.3)', borderWidth: 1, opacity: 0.7 } }
                    ]
                };
            }

            fetch('https://cdn.jsdelivr.net/npm/echarts/map/json/china.json')
                .then(response => response.json())
                .then(chinaJson => {
                    echarts.registerMap('china', chinaJson);

                    const option2020 = getOption(2020);
                    const option2025 = getOption(2025);
                    let currentYear = null;

                    function updateChart(year) {
                        const yearInt = parseInt(year, 10);
                        if (yearInt === currentYear) return; 
                        
                        currentYear = yearInt;
                        const option = (yearInt === 2020) ? option2020 : option2025;
                        myChart.setOption(option, { notMerge: true });

                        document.querySelectorAll('.step').forEach(stepEl => {
                            stepEl.classList.toggle('active', stepEl.dataset.year == year);
                        });
                    }
                    
                    // --- 滚动交互逻辑 ---
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const year = entry.target.dataset.year;
                                updateChart(year);
                            }
                        });
                    }, { 
                        // 当目标元素与视窗交叉区域占目标元素高度的60%时，触发回调
                        threshold: 0.6,
                    });

                    document.querySelectorAll('.step').forEach(step => {
                        observer.observe(step);
                    });

                })
                .catch(error => {
                    console.error('无法加载地图数据:', error);
                });

            window.addEventListener('resize', () => {
                myChart.resize();
            });
        });
    </script>
</body>
</html>